<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0a0a0f; color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .card { background-color: #1a1a2e; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
        .table { --bs-table-bg: #1a1a2e; --bs-table-color: #f8f9fa; --bs-table-border-color: rgba(255, 255, 255, 0.1); }
        .btn-primary { background-color: #6366f1; border-color: #6366f1; }
        .btn-primary:hover { background-color: #4f46e5; border-color: #4f46e5; }
        .student-img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 2px solid #6366f1;}
        .modal-content { background-color: #1a1a2e; color: #f8f9fa; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem;}
        .modal-header { border-bottom-color: rgba(255, 255, 255, 0.1); }
        .detail-label { color: #a1a1aa; font-weight: bold; }
        .modal-student-img { width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 4px solid #6366f1;}
        /* Styles for search/sort controls */
        .form-control, .form-select { background-color: #0a0a0f; color: #f8f9fa; border-color: rgba(255, 255, 255, 0.1); }
        .form-control:focus, .form-select:focus { background-color: #0a0a0f; color: #f8f9fa; border-color: #6366f1; box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25); }
        .input-group-text { background-color: #0a0a0f; border-color: rgba(255, 255, 255, 0.1); color: #a1a1aa; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                <h2 class="mb-0" style="color: #fff;"><i class="fas fa-user-graduate me-2"></i> Manage Students</h2>
            </div>
            <div class="card-body p-4">
                <!-- --- RESPONSIVE CONTROLS --- -->
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <form method="GET" action="{{ url_for('view_students') }}" class="d-flex flex-column flex-md-row flex-grow-1 gap-3 w-100" id="filterForm">
                        <div class="input-group flex-grow-1">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" name="search" class="form-control" placeholder="Search by name..." value="{{ search_term or '' }}">
                        </div>
                        <div class="input-group">
                            <label class="input-group-text" for="sortSelect">Sort By</label>
                            <select name="sort" id="sortSelect" class="form-select" onchange="document.getElementById('filterForm').submit()">
                                <option value="roll_no_asc" {% if sort_by == 'roll_no_asc' %}selected{% endif %}>Roll No (Asc)</option>
                                <option value="roll_no_desc" {% if sort_by == 'roll_no_desc' %}selected{% endif %}>Roll No (Desc)</option>
                                <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
                                <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
                            </select>
                        </div>
                    </form>
                    <div class="w-100 w-md-auto">
                        <a href="{{ url_for('add_student') }}" class="btn btn-primary w-100"><i class="fas fa-plus me-1"></i> Add New Student</a>
                    </div>
                </div>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Roll No</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>
                                    {% if student.image %}
                                        <img src="https://res.cloudinary.com/dsf4cui9f/image/upload/w_100,h_100,c_fill,f_auto,q_auto/{{ student.image }}" alt="{{ student.name }}" class="student-img">
                                    {% else %}
                                        <img src="{{url_for('static',filename='assets/students/default.png')}}" alt="No Image" class="student-img">
                                    {% endif %}
                                </td>
                                <td>{{ student.name }}</td>
                                <td>{{ student.roll_no }}</td>
                                <td>{{ student.dpt or 'N/A' }}</td>
                                <td>{{ student.ph_no or 'N/A' }}</td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-success me-2 view-btn" 
                                            data-bs-toggle="modal" data-bs-target="#studentDetailModal" 
                                            data-id="{{ student.id }}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-sm btn-outline-info me-2"><i class="fas fa-pencil-alt"></i> Edit</a>
                                    <form action="{{ url_for('delete_student', student_id=student.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this student?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i> Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-4">No student records found. Add one to get started!</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL (POPUP) STRUCTURE -->
    <div class="modal fade" id="studentDetailModal" tabindex="-1" aria-labelledby="studentDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentDetailModalLabel">Student Full Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBodyContent">
                    <p class="text-center">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const studentModal = document.getElementById('studentDetailModal');
        const modalBody = document.getElementById('modalBodyContent');
        studentModal.addEventListener('show.bs.modal', async (event) => {
            const button = event.relatedTarget;
            const studentId = button.getAttribute('data-id');
            modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            try {
                const response = await fetch(`/students/view/${studentId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const student = await response.json();
                if (student.error) {
                    throw new Error(student.error);
                }
                const format = (data) => data ? data : '<span class="fst-italic">N/A</span>';
                const imageUrl = student.image 
                    ? `https://res.cloudinary.com/dsf4cui9f/image/upload/w_300,h_300,c_fill,f_auto,q_auto/${student.image}`
                    : `{{url_for('static',filename='assets/students/default.png')}}`;
                
                modalBody.innerHTML = `
                    <div class="container-fluid p-3">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <img src="${imageUrl}" class="modal-student-img mb-3" alt="Student Image">
                                <h3>${format(student.name)}</h3>
                                <p class="lead">${format(student.roll_no)}</p>
                            </div>
                            <div class="col-md-8">
                                <h5><i class="fas fa-user-circle me-2 text-primary"></i> Personal Details</h5>
                                <div class="row">
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">Email:</span><br>${format(student.email)}</p></div>
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">Phone:</span><br>${format(student.ph_no)}</p></div>
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">Department:</span><br>${format(student.dpt)}</p></div>
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">DOB:</span><br>${format(student.dob)}</p></div>
                                </div>
                                <hr class="my-3">
                                <h5><i class="fas fa-users me-2 text-primary"></i> Parent's Details</h5>
                                <div class="row">
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">Father's Name:</span><br>${format(student.f_name)}</p></div>
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">Father's Phone:</span><br>${format(student.f_phno)}</p></div>
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">Mother's Name:</span><br>${format(student.m_name)}</p></div>
                                    <div class="col-sm-6 mb-2"><p><span class="detail-label">Mother's Phone:</span><br>${format(student.m_phno)}</p></div>
                                </div>
                                <hr class="my-3">
                                <h5><i class="fas fa-id-card me-2 text-primary"></i> Other Info</h5>
                                <p><span class="detail-label">Aadhaar No:</span><br>${format(student.aadhaar_no)}</p>
                                <p><span class="detail-label">Address:</span><br>${format(student.address)}</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to fetch student details:', error);
                modalBody.innerHTML = '<p class="text-center text-danger p-5">Failed to load details. Please try again.</p>';
            }
        });
    </script>
</body>
</html>
